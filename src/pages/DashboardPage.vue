<script setup>
import AssideDash from '@/components/dashboard/AssideDash.vue';
import HeaderDash from '@/components/dashboard/HeaderDash.vue';
import FooterDash from '@/components/dashboard/FooterDash.vue';
import { ref, onMounted, onUnmounted } from 'vue'
import { useRouter } from 'vue-router'
import axios from 'axios'

const router = useRouter()
const userData = ref({
  firstName: '',
  name: '',
  email: ''
})
const educativeData = ref([])
const provinceData = ref([])
const spinneretData = ref([]) // ðŸ”¥ ajoutÃ© pour spinnerets
const token = localStorage.getItem('token')
const userEmail = localStorage.getItem('userEmail')
const apiBaseUrl = import.meta.env.VITE_API_BASE_URL

function isTokenValid(token) {
  if (!token) return false
  try {
    const payload = JSON.parse(atob(token.split('.')[1]))
    return payload.exp > Date.now() / 1000
  } catch {
    return false
  }
}

async function fetchUserData() {
  try {
    if (!isTokenValid(token)) {
      localStorage.removeItem('token')
      router.push('/sign-in')
      return
    }

    const response = await axios.get(`${apiBaseUrl}/api/users`, {
      headers: {
        Authorization: `Bearer ${token}`
      }
    })
    console.log(`1. l'email est : ${userEmail}`)

    if (response.data.member && response.data.member.length > 0) {
      const authenticatedUser = response.data.member.find(user => user.email === userEmail)
      console.log(`2. l'email est : ${userEmail}`)

      if (authenticatedUser) {
        console.log(`3. l'email est : ${userEmail}`)
        userData.value = authenticatedUser
      }
    }
  } catch (error) {
    if (error.response?.status === 401) {
      localStorage.removeItem('token')
      router.push('/sign-in')
    }
    console.error('Error fetching user data:', error)
  }
}

async function fetchEducative() {
  try {
    if (!isTokenValid(token)) return
    const response = await axios.get(`${apiBaseUrl}/api/educative_systemes`, {
      headers: {
        Authorization: `Bearer ${token}`
      }
    })
    if (response.data.member && response.data.member.length > 0) {
      educativeData.value = response.data.member
    }
  } catch (error) {
    if (error.response?.status === 401) {
      localStorage.removeItem('token')
      router.push('/sign-in')
    }
    console.error('Error fetching educative data:', error)
  }
}

async function fetchProvince() {
  try {
    if (!isTokenValid(token)) return
    const response = await axios.get(`${apiBaseUrl}/api/provinces`, {
      headers: {
        Authorization: `Bearer ${token}`
      }
    })
    if (response.data.member && response.data.member.length > 0) {
      provinceData.value = response.data.member
    }
  } catch (error) {
    if (error.response?.status === 401) {
      localStorage.removeItem('token')
      router.push('/sign-in')
    }
    console.error('Error fetching province data:', error)
  }
}

async function fetchSpinnerets() { 
  try {
    if (!isTokenValid(token)) return
    const response = await axios.get(`${apiBaseUrl}/api/spinnerets`, {
      headers: {
        Authorization: `Bearer ${token}`
      }
    })
    if (response.data.member && response.data.member.length > 0) {
      spinneretData.value = response.data.member
    }
  } catch (error) {
    if (error.response?.status === 401) {
      localStorage.removeItem('token')
      router.push('/sign-in')
    }
    console.error('Error fetching spinneret data:', error)
  }
}

let paceScript = null;

onMounted(async () => {
  await Promise.all([
    fetchUserData(),
    fetchEducative(),
    fetchProvince(),
    fetchSpinnerets() // ðŸ”¥ ajoutÃ© au montage
  ])

  // CrÃ©e une nouvelle balise script
  paceScript = document.createElement('script');
  paceScript.src = '/assets/vendor/pace-progress/pace.min.js';
  paceScript.async = true;
  paceScript.id = 'pace-script';

  document.body.appendChild(paceScript);
});

onUnmounted(() => {
  if (paceScript) {
    document.body.removeChild(paceScript);
  }
  const paceElements = document.querySelectorAll('.pace');
  paceElements.forEach(el => el.remove());
});
</script>

<template>
<div class="app">
  <HeaderDash :userData msg="Dashboard"/>
  <AssideDash msg="Dashboard"/>
  <router-view 
    :userData="userData" 
    :educativeData="educativeData" 
    :provinceData="provinceData"
    :spinneretData="spinneretData" 
  />
  <FooterDash msg="Dashboard"/>
</div>
</template>
